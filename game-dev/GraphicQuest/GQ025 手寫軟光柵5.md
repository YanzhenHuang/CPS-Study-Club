# GQ025 手寫軟光柵5
今天寫點折射率公式(斯涅爾定律):

$$
\eta \cdot \sin\theta = \eta' \cdot \sin\theta'
$$

![](pic/fig-1.13-refraction.jpg)

我們要解 $\sin\theta'$ :

$$
\sin\theta' = \frac{\eta}{\eta'} \cdot \sin\theta
$$

我們假設反射面有一條反射光 $\mathbf{R'}$ 和法線 $\mathbf{n'}$ ，它們之間存在一個夾角 $\theta'$ ，我們可以把反射光 $\mathbf{R'}$ 分開成兩個部分: 垂直於法線 $\mathbf{n'}$ 和平行於法線 $\mathbf{n'}$ 的向量

$$
\mathbf{R'} = \mathbf{R'}_{\bot} + \mathbf{R'}_{\parallel}
$$

我們其實可以分別求解這兩個向量:

$$
\mathbf{R'}_{\bot} = \frac{\eta}{\eta'} (\mathbf{R} + \cos\theta \mathbf{n})
$$

$$
\mathbf{R'}_{\parallel} = -\sqrt{1 - |\mathbf{R'}_{\bot}|^2} \mathbf{n}
$$

你可以自己證明一下，其實使用 $\sin\theta = \frac{a}{b}$ 也可以夠用了。 (當然你發現了 $cos$ 也知道要用到別的公式 ^_^ )

那麼我們可以開始求解 $\cos\theta$ : 用向量相乘公式

$$
\mathbf{a} \cdot \mathbf{b} = |\mathbf{a}| |\mathbf{b}| \cos\theta
$$

我們假設 $|\mathbf{a}|$ 和 $|\mathbf{b}|$ 都是基向量 (都是1)

$$
\mathbf{a} \cdot \mathbf{b} = \cos\theta
$$

那麼我們就可以重寫 $\mathbf{R'}_{\bot}$ : 

$$
\frac{\eta}{\eta'} (\mathbf{R} + (\mathbf{-R} \cdot \mathbf{n}) \mathbf{n})
$$

好吧，那麼寫好公式以後就是寫代碼了:

```c++
// 函數中的 fmin 和 sqrt 函數分別用於確保餘弦值在 [0,1] 範圍內，併計算反射向量的水平分量的長度。
vec3 refract(const vec3& uv, const vec3& n, double etai_over_etat)
{
    // 函數首先使用點積計算出入射向量和法線向量之間的夾角的餘弦值
	auto cos_theta = fmin(dot(-uv, n), 1.0f);
	vec3 r_out_prep = etai_over_etat * (uv + cos_theta * n);
	vec3 r_out_parallel = -sqrt(fabs(1.0 - r_out_parallel.length_squared())) * n;
	return r_out_prep + r_out_parallel;
}
```

```c++
// 電介質?
class dielectric : public material
{
public:
    dielectric(double index_of_reflection) : ir(index_of_reflection) {}
    virtual bool scatter(
        const ray& r_in, const hit_record& rec, color& attenuation, ray& scattered
    ) const override
    {
        attenuation = color(1.0, 1.0, 1.0);
        double refraction_ratio = rec.front_face ? (1.0 / ir) : ir;
        
        vec3 unit_direction = unit_vector(r_in.direction());
        vec3 refracted = refract(unit_direction, rec.normal, refraction_ratio);
        scattered = ray(rec.p, refracted);

        return true;
    }
public:
    double ir; // Index of Refraction
};
```


 